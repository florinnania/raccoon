#!/usr/bin/env python

import os
import sys
from IPython.frontend.terminal.ipapp import TerminalIPythonApp
from IPython.frontend.terminal.interactiveshell import TerminalInteractiveShell


BANNER = """
Raccoon interactive shell
"""

PRELOAD = """
from raccoon.models import Project, Connector, User
from raccoon.interfaces.github import GitHubInterface
from raccoon.interfaces.jenkins import JenkinsInterface

from tornado.ioloop import IOLoop
from motorengine.connection import connect

from raccoon.settings import DB, APP, PORT

# Connect to DB
io_loop = IOLoop.instance()
connect(DB['name'], host=DB['host'], port=DB['port'], io_loop=io_loop)

def run(func, *args, **kwargs):
    return IOLoop.instance().run_sync(lambda :func(*args, **kwargs))
"""


def init_shell(cls):
        """initialize the InteractiveShell instance"""
        sys.path.insert(0, '')

        cls.shell = TerminalInteractiveShell.instance(
            config=cls.config,
            banner1='\nRaccoon Interactive Shell',
            banner2='==========================\n'
                    'Imported objects: Project, Connector, User, GitHubInterface, JenkinsInterface\n\n',
            display_banner=False,
            profile_dir=cls.profile_dir,
            ipython_dir=cls.ipython_dir
        )
        cls.shell.configurables.append(cls)

TerminalIPythonApp.init_shell = init_shell

def main():
    app = TerminalIPythonApp.instance()
    app.initialize(argv=[])
    app.shell.run_code(PRELOAD)

    app.start()


if __name__ == '__main__':
    main()
